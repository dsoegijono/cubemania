<%- javascript_tag do -%>
  interval = null;
  
  function toggleTimer() {
    if ($("#dynamic").is(":visible") && $("#timer tr.done").length != <%= @puzzle.attempt_count %>)
      this.interval == null ? startTimer() : stopTimer();
  }
  function startTimer() {
    if (<%= @puzzle.countdown %> == 0) {
      startTime = new Date().getTime();
      $("#go").addClass("running");
      interval = setInterval(countUp, 5);
    } else {
      $("#go").text(<%= @puzzle.countdown %>).addClass("countdown");
      interval = setInterval(countDown, 1000);
    } 
  }
  function countDown() {
    var time = $("#go").text() - 1;
    $("#go").text(time);
    if (time == 0) {
      $("#go").removeClass("countdown").addClass("running");
      clearInterval(interval);
      startTime = new Date().getTime();
      interval = setInterval(countUp, 5);
    }
  }
  function countUp() {
    var time = (new Date().getTime() - startTime);
    $("#go").text(formatTime(time));
  }
  function stopTimer() {
    clearInterval(interval); interval = null;
    if ($("#go").hasClass("countdown")) {
      $("#go").text("GO!").removeClass("countdown");
    }
    else {
      var time = (new Date().getTime() - startTime);
      addTime(time);
      $("#go").removeClass("running");
    }
  }
  function insertTime() {
    var time = $('#type').val();
    if (isNaN(time)) {
      alert('Please enter the time in seconds.');
    }
    else {
      addTime(Math.round(time * 1000));
      $('#type').val('');
    }
  }
  function addTime(time) {
    $("#go").text(formatTime(time));
    $("#timer tr.done:last .flags .delete").hide();
    $("#timer tr:not(.done):first").find(".milliseconds").text(time)
    $("#timer tr:not(.done):first").addClass("done").find(".time").text(formatTime(time));
    updateWorstAndBest();
    updateAverage();
    if ($("#timer tr.done").length < <%= @puzzle.attempt_count %>) {
      updateScramble();
    }
  }
  function getMilliseconds() {
    return $("#timer tr.done .milliseconds").map(function() {
      var time = parseInt($(this).text());
      return isNaN(time) ? 0 : time;
    }).get();
  }
  function updateWorstAndBest() {
    $("#timer tr.done").removeClass("worst").removeClass("best");
    if ($("#timer tr.done:not(.dnf)").length < 2) return;
    var times = $("#timer tr.done:not(.dnf) .milliseconds").map(function() {
      var time = parseInt($(this).text());
      return isNaN(time) ? 0 : time;
    }).get();
    var minIndex = times.inArray(times.min());
    var maxIndex = times.inArray(times.max());
    if ($("#timer tr.dnf").length > 0) {
      $("#timer tr.dnf:first").addClass("worst");
    } else {
      $("#timer tr.done:not(.dnf):eq(" + maxIndex + ")").addClass("worst");
    }
    $("#timer tr.done:not(.dnf):eq(" + minIndex + ")").addClass("best");
  }
  function calculateAverageOfAllTimes() {
    return getMilliseconds().average();
  }
  function calculateAverage() {
    var count = $("#timer tr.done").length;
    var dnfCount = $("#timer tr.dnf").length;
    if (count == 0) return 0;
    if (count < 3) {
      return calculateAverageOfAllTimes();
    } else {
      if (dnfCount > 1) {
        return calculateAverageOfAllTimes();
      }
      var times = $("#timer tr.done:not('.dnf') .milliseconds").map(function() {
        var time = parseInt($(this).text());
        return isNaN(time) ? 0 : time;
      }).get();
      times.sort(function(a, b) {
        return a - b;
      });
      if (dnfCount == 0) {
        times.pop();
      }
      times.shift();
      return times.average();
    }
  }
  function calculateMean() {
    if ($("#timer tr.done:not(.dnf)").length == 0) {
      return calculateAverageOfAllTimes();
    } else {
      return $("#timer tr.done:not(.dnf) .milliseconds").map(function() {
        var time = parseInt($(this).text());
        return isNaN(time) ? 0 : time;
      }).get().average();
    }
  }
  function calculateBestOf() {
    if ($("#timer tr.done:not(.dnf)").length == 0)
      return getMilliseconds().min();
    return $("#timer tr.done:not(.dnf) .milliseconds").map(function() {
      var time = parseInt($(this).text());
      return isNaN(time) ? 0 : time;
    }).get().min();
  }
  function updateScramble() {
    $("#scramble").text($("#timer tr:not(.done):first .scramble").text());
  }
  function commitTimes() {
    $("#timer input[type=button]").attr("disabled", "disabled");
    var average = calculate<%= @puzzle.average_format.camelize %>();
    var map = {"average[time]": average, <%= '"average[competition_id]": ' + competition_id.to_s + ',' unless competition_id.nil? %> "average[dnf]": $("#average span").hasClass("dnf"), "average[comment]": $("#comment").val(), "authenticity_token": "<%= form_authenticity_token %>"};
    $("#timer tr.done").each(function(index) {
      map["singles[" + index + "][time]"] = $(this).find(".milliseconds").text();
      map["singles[" + index + "][scramble]"] = $(this).find(".scramble").text();
      map["singles[" + index + "][dnf]"] = $(this).hasClass("dnf");
      <%= 'map["singles[" + index + "][competition_id]"] = ' + competition_id.to_s + ';' unless competition_id.nil? %>
    });
    map["input_method"] = $("#dynamic").is(":visible") ? 'dynamic' : 'manual';
    $.post("<%= kind_puzzle_times_path params[:kind_id], params[:puzzle_id] %>", map, null, "script");
  }
  function updateAverage() {
    if ($("#timer tr.done").length == <%= @puzzle.attempt_count %>) {
      $("#timer input[type=button]").removeAttr("disabled");
      $('#type').attr("disabled", "disabled");
    } else {
      $("#timer input[type=button]").attr("disabled", "disabled");
      $('#type').removeAttr("disabled", "disabled").focus();
    }
    <% case @puzzle.average_format
         when 'best_of' %>
    if ($("#timer tr.done").length > 0 && $("#timer tr.done").length - $("#timer tr.dnf").length == 0) {
    <%   when 'mean' %>
    if ($("#timer tr.dnf").length > 0) {
    <%   when 'average' %>
    if ($("#timer tr.dnf").length > 1) {
    <% end %>
      $("#average span").addClass("dnf");
    } else {
      $("#average span").removeClass("dnf");
    }
    $("#average span").text(formatTime(calculate<%= @puzzle.average_format.camelize %>()));
  }
  function deleteLastTime() {
    $("#timer tr.done:last .time").text("-");
    $("#timer tr.done:last .milliseconds").text("");
    $("#timer tr.done:last").removeClass();
    $("#timer tr.done:last .flags .delete").show();
    updateAverage();
    updateWorstAndBest();
    updateScramble();
  }
  function toggleDnf(index) {
    if ($("#timer tr:eq(" + index + ")").hasClass("plus2")) {
      $("#timer tr:eq(" + index + ") .milliseconds").text(parseInt($("#timer tr:eq(" + index + ") .milliseconds").text()) - 2000);
      $("#timer tr:eq(" + index + ") .time").text(formatTime($("#timer tr:eq(" + index + ") .milliseconds").text())) 
    }
    $("#timer tr:eq(" + index + ")").toggleClass("dnf").removeClass("plus2");
    updateAverage();
    updateWorstAndBest();
  }
  function togglePlus2(index) {
    $("#timer tr:eq(" + index + ")").toggleClass("plus2").removeClass("dnf");
    var time = parseInt($("#timer tr:eq(" + index + ") .milliseconds").text());
    if ($("#timer tr:eq(" + index + ")").hasClass("plus2")) {
      time += 2000;
    } else {
      time -= 2000; 
    }
    $("#timer tr:eq(" + index + ") .time").text(formatTime(time));
    $("#timer tr:eq(" + index + ") .milliseconds").text(time);
    updateAverage();
    updateWorstAndBest();
  }
  Array.prototype.max = function() {
    return Math.max.apply(Math, this);
  };
  Array.prototype.min = function() {
    return Math.min.apply(Math, this);
  };
  Array.prototype.inArray = function(value) {
    for (var i = 0; i < this.length; i++) {
      if (this[i] == value) return i;
    }
    return -1;
  }
  Array.prototype.average = function() {
    var sum = 0;
    for (var i = 0; i < this.length; i++) {
      sum += this[i];
    }
    return Math.round(sum/this.length);
  }
  function formatTime(time) {
    var seconds = time / 1000;
    if (seconds < 60) {
      return seconds.toFixed(2);
    } else {
      var minutes = Math.floor(seconds / 60);
      seconds = seconds - minutes * 60;
      var s = seconds < 10 ? "0" : "";
      return minutes + ":" + s + seconds.toFixed(2);
    }
  }
  function toggleInputMethod() {
    $('#dynamic').toggle();
    $('#manual').toggle();
    $('#type').focus();
    if ($("#timer tr.done").length == <%= @puzzle.attempt_count %>) {
      $('#type').attr("disabled", "disabled");
    }
  }
  $(document).keydown(function(event) {
    if (event.keyCode == 32) {
      return false;
    }
  });
  $(document).keyup(function(event) {
    if (event.keyCode == 32 || event.keyCode == 83) {
      toggleTimer();
    }
  });
  updateScramble();
<%- end -%>